---
typora-copy-images-to: ..\img
---

### 统一消息平台-邮件单推服务



#### 问题:


1. **流控:** 139接口限流为300,统一消息对外限流是否分用户,用户限流策略如何分配.
2. **同步 or 异步:** 同步服务无法走kafka,是否单起服务进行处理.
3. **限制:** 512k 是否包含模板.
4. **定时发送:** 该功能是否需要实现.



----





#### 功能模块:



- **接入管理**
  - 维护允许使用邮件发送服务的第三方组织,并维护其上下级关系.
- **模板管理**
  - 维护模板内容,并维护与组织的对应关系.
- **通道管理**
  - 下游邮件通道的管理,维护接口地址,鉴权信息,限流信息等.
- **发送管理**
  - 接口请求记录,即发送记录.用户追踪以及报表统计
- **定时推送**
  - 定时扫描要定时推送的记录

---



#### 架构图

 ![架构设计](D:\docs\typora_doc\img\架构设计.png)

#### 数据结构

##### 接入表 t_push_email_group

##### 模板表 t_msg_template(旧表复用)

##### 接入方与模板对应关系表 t_email_group_template

##### 通道表 t_channel_email_info

##### 发送记录表 t_push_email_msg

![1558515051791](D:\docs\typora_doc\img\1558515051791.png)



#### 接口定义

##### 邮件单发接口

- 接口说明:

  邮件单发服务接口.

- 地址:

  http://host:port/mc/pushMailMsg?appkey=xxxxxx

- method:

  post

- 入参

  | 参数        | 类型   | 是否必填 | 默认值 | 描述                    |
  | ----------- | ------ | -------- | ------ | ----------------------- |
  | system_id | String | 是 | | 身份认证 |
  | req_no | String | 是 | | 幂等校验,**防止重复发送** |
  | c_id        | String | 是       |        | 接入方编号              |
  | template_id | String | 是       |        | 编号                    |
  | is_timing   | String | 是       | 0      | 是否定时发送 1是 0否    |
  | level       | String | 是       | 0      | 优先级                  |
  | exp_time    | int    | 是       | 1500   | 过期时间 单位ms         |
  | email_server | string | 是 | 139 | 邮件服务上编号 139->139邮箱 |
  | to_email    | String | 是       |        | 收件人                  |
  | to_name     | string | 否       |        | 收件人别名 默认为收件人 |
  | email_title | string | 是 |        | 邮件标题 |
| email_paramter | list | 是 |        | 参数列表 |
  
**email_parameter**
  
  | 参数       | 类型   | 是否必填 | 默认值 | 描述    |
  | ---------- | ------ | -------- | ------ | ------- |
  | attr_code  | String | 是       |        | 参数key |
| attr_value | String | 是       |        | 参数值  |
  
  注:

​		**attr_code枚举:**具体枚举值 ,根据模板定义输出.

​		

- 出参

  | 参数 | 类型   | 描述                                    |
  | ---- | ------ | --------------------------------------- |
  | code | int    | 平台收到消息是否成功的标识，0成，-1失败 |
  | msg  | String | 返回的信息                              |
  |      |        |                                         |

  

#### 包组件描述

![未命名文件 (D:\docs\typora_doc\img\未命名文件 (1)-1558683394212.png)](e:\Desktop\未命名文件 (1).png)



